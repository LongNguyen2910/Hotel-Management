@model Hotel_Management.Helpers.PaginatedList<Hotel_Management.Models.Nhanvien>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_ContentNavbarLayout.cshtml";
}

<div class="col-12">
    <div class="card overflow-hidden">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Danh sách nhân viên</h5>
            <div class="d-flex align-items-center">
                <form asp-action="Index" method="get" class="d-flex me-3" id="searchForm">
                    <input type="text" name="searchString" value="@ViewData["CurrentFilter"]" class="form-control form-control-sm me-2" placeholder="Tìm theo tên..." />
                    <button type="submit" class="btn btn-sm btn-outline-primary">Tìm</button>

                    @if (ViewData["CurrentFilter"] != null)
                    {
                        <a asp-action="Index" class="btn btn-sm btn-link ms-2">Xóa</a>
                    }
                </form>
                @if (User.IsInRole("Admin") || User.IsInRole("Quản lý nhân sự") || User.IsInRole("Quản lý khách sạn"))
                {
                    <a asp-controller="Nhanviens" asp-action="Create" class="btn btn-sm btn-primary">Thêm nhân viên</a>
                }            
            </div>
        </div>
        <div id="nhanvienTableContainer">
            @await Html.PartialAsync("NhanviensTable", Model)
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            const tableContainer = document.getElementById('nhanvienTableContainer');
            const searchForm = document.getElementById('searchForm');

            // Hàm tải nội dung AJAX
            function loadTable(url) {
                // Hiển thị loading (nếu muốn)
                // tableContainer.innerHTML = 'Đang tải...';

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Đây là chìa khóa để Controller nhận diện AJAX
                    }
                })
                .then(response => response.text())
                .then(html => {
                    tableContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Lỗi khi tải dữ liệu:', error);
                    // Xử lý lỗi (ví dụ: hiển thị thông báo)
                });
            }

            // 1. Bắt sự kiện submit của Form Tìm kiếm
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Ngăn form submit và tải lại trang

                const formData = new FormData(this);
                const queryString = new URLSearchParams(formData).toString();
                const url = `${this.action}?${queryString}`;

                loadTable(url);
            });

            // 2. Bắt sự kiện click cho Phân trang, Xóa filter, và Click vào hàng
            // Chúng ta dùng "event delegation" vì các nút này được tải lại liên tục
            tableContainer.addEventListener('click', function(e) {

                // Tìm xem có click vào nút phân trang/xóa filter không
                const ajaxLink = e.target.closest('a.ajax-link');
                if (ajaxLink && !ajaxLink.classList.contains('disabled')) {
                    e.preventDefault(); // Ngăn link tải lại trang
                    loadTable(ajaxLink.href);
                    return; // Dừng lại
                }

                // Tìm xem có click vào nút Sửa/Xóa không
                const actionLink = e.target.closest('a.ajax-action');
                if (actionLink) {
                    // Đây là nút Sửa/Xóa, không làm gì cả, để link hoạt động bình thường
                    return;
                }

                // Tìm xem có click vào hàng không
                const clickableRow = e.target.closest('.clickable-row');
                if (clickableRow) {
                    // Đây là script "clickable-row" gốc của bạn
                    window.location.href = clickableRow.dataset.href;
                }
            });

        });
    </script>
}